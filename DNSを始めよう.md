# DNSを始めよう

### 想定する読者層

* これからシステムやプログラミングを勉強しようとしている人
* ウェブ系で開発をしているアプリケーションエンジニア
* インフラがよく分からないことにコンプレックスがある人
* ドメインを買ったりするけどDNSはあまり分かってない人
* ブログやポートフォリオを独自ドメインで作ってみたい人
* AWSやRoute53などの単語に興味がある人

**ちなみに天木はいかに該当**
* ウェブ系で開発をしているアプリケーションエンジニア

### この本の特徴

* 実際にドメインを購入して色々試せる
* トラブルが発生した時に、「どう調べたらいのか」「どう解決したらいいのか」「どうしたら事前に防げるか」を理解できる

### この本のゴール

* ドメインを買う時には何に注意してどこで買ったらいいか分かってる
* Whois情報に何を登録したらいいかわかってる
* 障害が発生した時にターミナルでdigコマンドやwhoisコマンドをくしして原因を調査できる
* サイト移管時に「DNS浸透待ちで長時間切り替わりません」と言わない
* 読む前よりDNSが好きになっている

### ドメインとWhois

##### ドメインのお店選び

* お名前 .com
* 名付けてネット
* Yahooドメイン
* ムームードメイン
* その他。。。

##### 値段や店によってドメインの品質は違うのか？

違わない。何円で買おうが同じ品質

##### ドメインをうる会社はレジストラとリセラの2種類がある。

* レジストラ(登録事業者)
* リセラ(販売事業者)

リセラはレジストラからドメインを仕入れて提供してくるので、末端価格が高くなる。

##### ドメイン選びのポイント

* 2年目以降の価格も確認する（長期間利用するならなおさら）
* 設定変更が容易にできるかどうか

##### ドメインが生まれて手元に届くまで

* レジストラはドメインをレジストリ(登録管理組織)から仕入れる
* 1つのTLDには1つのレジストリ
    ```
    TLD：　トップレベルドメイン(ex. .jp, .com)
    ```
    つまり.jpを管理するレジストリは1つしかない

##### なぜ1つのレジストリがTLDを独占する？

重複を避けるため

##### ICANNがレジストリを決める

```
ICANN: インターネットのIPアドレスやドメイン名等の資源を全世界的に調整・管理する非営利法人
```

##### どのTLDを取り扱うかはお店が自由に決められる

##### 実際にドメインを買ってみる

##### Whoisとは？

* 絶対に登録しないといけないもの
* ドメインを保有して組織または人の氏名・連絡先が誰でもわかるもの
* whoisの登録情報はレジストリごとに微妙に違う
* whois情報は「https://www.aguse.jp」で調べると早いかも
* whois情報は取得者通しで係争が発生した場合に当事者通しでやりとりができるように個人情報等正確な情報が公開されている。
* **ドメイン情報認証メールを無視すると停止されてしまう**
* **whois情報にはクライアント情報を載せるべき**
　みる人が見れば、どの会社がクライアント企業のWebページ制作に携わってるかわかってしまう
* **プライバシーを守るためのwhois情報公開代行がある**

##### .co.jpは国内企業しか買えない

##### ドメインの有効期限が切れるとどうなるか

　一定期間経過後再度購入できるようになる。価値あるドメインについてはドロップキャッチされ悪用される可能性がある。

##### ドメインを買ったところで特にそのページがみれる訳でもない
<br>
### DNSの仕組み

##### DNSとは？
```
　DNS: Domain Name System (ドメイン名の管理システム)
　一口にDNSサーバと言っても、「ネームサーバ」と「フルリゾルバ」の2つがある
```

##### ネームサーバ
```
　電話帳のような役割を担う。
　ドメインとそれに紐づくIPアドレスを記録している
　「DNSコンテンツサーバ」「権威DNSサーバ」と呼ばれることもある
```

##### フルリゾルバ
```
　秘書のような役割を担う。
　ドメインに紐づくIPアドレスを知りたい時にあちこちのネームサーバ回って情報を取得してきてくれる
　(取得した情報はキャッシュされる)
```

##### お名前のページが表示されるまで

フルリゾルバが自分のとこに情報がないのを確認して、ネームサーバに聞きに言って、色々回って回収して、、、

##### ゾーンと委任

DNSは1つのネームサーバが「全てのことを知っている」という一極集中の形では管理しておらず、分散して管理している。

##### リソースレコード
```
　リソースレコード：「ドメインとIPアドレスの紐付け」一つ一つのこと
```

| リソースレコードのタイプ |                   値の意味                   |
| ------------------------ | -------------------------------------------- |
| **Aレコード**                | ドメインに紐づくIPアドレス                   |
| NSレコード               | ドメインのゾーンを管理するネームサーバ       |
| MXレコード               | ドメインに紐づくメール受信サーバ             |
| TXT(SPF)                 | このドメインのメール送信元サーバ             |
| SOA                      | ドメインのゾーンの管理情報                   |
| **Cレコード**                | このドメインの別名でリソースレコードの参照先 |

### AWSのネームサーバ(Route53)を使って見よう

##### AWSとは
省略

##### AWSアカウント作成
省略

##### ドメインのネームサーバをRoute53に変更

* Route53でホストゾーンを作成
* 自分のドメインのネームサーバが何か確認
* ネームサーバをお名前 .comからRoute53に変更
* TTLが過ぎるまではネームサーバが切り替わらない
    　よく言われる「DNSno浸透には時間がかかる」とはキャッシュの有効期限が残っているために古い情報が参照され続けることが原因。

### digとWhoisを叩いて学ぶDNS

##### digとwhoisのインストール
dig,whoisコマンドは必ずインストールされている訳じゃない。インストールしてなければyumコマンドで入れる。(Macならインストール済)

* MacもLinuxのサーバ環境もなければ
    　AWSでEC2インスタンスを作ってやるとか「【DNSサーバ接続確認】」というページで擬似的に試すのも有。

##### nslookupはもう卒業！ digコマンドの便利な使い方

digコマンドを使うとドメインに紐づくIPアドレスまたは、IPアドレスに紐づくドメインを調べることができる。

* 紐づくIPアドレスだけ知りたかったという時には、末尾に「+short」オプションをつける。

##### Whoisを叩いてドメインやIPの持ち主を調べよう

whoisコマンドを使うとwhois情報、ドメインの持ち主、IPアドレスの持ち主を調べることができる

* Aレコード
    ```
    　Aレコード：　ドメイン名からIPアドレスを正引きできるもの
    ```
<br>

* MXレコード
    ```
    　MXレコード：メールアドレス宛にメールを送ったらこのメールサーバで受信するという設定をしているもの
    ```

    先頭の文字はプリファレンス値という。(ex. 0,10,20)
    MXレコードは複数設定でき、代替性や冗長性を高めたりできる。
    MXレコードがなければウェブサーバ宛にメールが届く
    自分のものでないドメインを使うのはかなり危険！(試しに使うならexample.~を使う方がいい)
<br>

* NSレコード
    ```
    　NSレコード: ドメインのネームサーバをしているもの
    ```

* SPFレコード(TXTレコード)
    ```
    　SPFレコード： メールの送信元がどこかを特定できるもの
    ```

* PTRレコード
    ```
    　PTRレコード： IPアドレスからドメインを逆引きできるレコードのこと
    ```

* CNAMEレコード
    ```
    　CNAMEレコード： ドメインの別名、リソースレコードの参照先
    　CNAMEと他のリソースレコードは共存できない。
    ```
